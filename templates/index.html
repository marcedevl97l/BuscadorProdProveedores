<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador Unificado</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üîç Buscador de Productos</h2>
            <p class="subtitle">Sistema unificado de b√∫squeda y comparaci√≥n de precios</p>
            <div class="header-actions">
                <button class="cart-btn" onclick="toggleCart()">üõí Carrito (<span id="cart-count">0</span>)</button>
                <a href="/logout" class="logout-btn">Cerrar Sesi√≥n</a>
            </div>
        </div>
        
        <div class="fuentes-info">
            <h4>üìä Base de Datos Activas: {{ fuentes|join(', ') }} - Actualizado al: {{ fecha_actualizacion }}</h4>
        </div>
        
        <div class="search-section">
            <form method="POST">
                <input type="hidden" name="page" value="1">
                <input type="text" name="q" placeholder="Buscar por producto, c√≥digo o proveedor..." value="{{ current_q }}" required autofocus>
                <select name="proveedor">
                    <option value="todos">Todos los laboratorios</option>
                    {% for prov in proveedores %}
                    <option value="{{ prov }}" {% if current_proveedor == prov %}selected{% endif %}>{{ prov }}</option>
                    {% endfor %}
                </select>
                <select name="sort">
                    <option value="nombre_asc" {% if current_sort == 'nombre_asc' %}selected{% endif %}>Nombre: A - Z</option>
                    <option value="nombre_desc" {% if current_sort == 'nombre_desc' %}selected{% endif %}>Nombre: Z - A</option>
                </select>
                <button type="submit">üîé Buscar</button>
            </form>
        </div>

        {% if sin_stock %}
        <div class="alert-sin-stock">
            <span style="font-size: 24px;">‚ùå</span>
            <span>SIN STOCK ‚Äî Producto no encontrado en ninguna fuente disponible</span>
        </div>
        {% endif %}

        {% if resultados %}
        <div class="results-section">
            <div class="results-header">
                <div class="results-title">
                    <span>Resultados de b√∫squeda:</span>
                    <span class="results-count">{{ resultados|length }} producto(s)</span>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" id="comparison-btn" onclick="toggleView('comparison')">
                        üìä Comparar
                    </button>
                    <button class="view-btn" id="list-btn" onclick="toggleView('list')">
                        üìã Lista
                    </button>
                </div>
            </div>

            <!-- Vista de Comparaci√≥n -->
            <div id="comparison-view" class="comparison-view active">
                {% set sources = {} %}
                {% for r in resultados %}
                    {% set fuente = r[4].split('|')[0] %}
                    {% if fuente not in sources %}
                        {% set _ = sources.update({fuente: []}) %}
                    {% endif %}
                    {% set _ = sources[fuente].append(r) %}
                {% endfor %}

                {% for fuente, productos in sources.items() %}
                    {% set fuente_lower = fuente.lower() %}
                    <div class="source-column">
                        {% if 'pionero' in fuente_lower %}
                            <div class="source-header pionero">üì¶ {{ fuente }}</div>
                        {% elif 'prosalud' in fuente_lower %}
                            <div class="source-header prosalud">üè• {{ fuente }}</div>
                        {% elif 'farmacom' in fuente_lower %}
                            <div class="source-header farmacom">üíä {{ fuente }}</div>
                        {% elif 'web' in fuente_lower %}
                            <div class="source-header web">üåê {{ fuente }}</div>
                        {% else %}
                            <div class="source-header otro">üìã {{ fuente }}</div>
                        {% endif %}

                        {% for producto in productos %}
                            {% set precio = producto[3]|float %}
                            {% set precios_producto = [] %}
                            {% for r in resultados %}
                                {% if r[1] == producto[1] %}
                                    {% set _ = precios_producto.append(r[3]|float) %}
                                {% endif %}
                            {% endfor %}
                            {% set precio_minimo = precios_producto|min %}
                            
                            <div class="product-card" data-precio-base="{{ precio }}" data-escala="{{ producto[5] or '' }}" data-precio-escala="{{ producto[6] or '' }}">
                                <div class="product-name">{{ producto[0] }}</div>
                                <div class="product-details">
                                    <div class="detail-row">
                                        <span class="detail-label">C√≥digo:</span>
                                        <span class="codigo-badge">{{ producto[1] }}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">Proveedor:</span>
                                        <span class="proveedor-text">{{ producto[2] }}</span>
                                    </div>
                                    {% if 'prosalud' in fuente_lower and producto[7] %}
                                    <div class="detail-row">
                                        <span class="detail-label">F. Venc.:</span>
                                        <span class="vencimiento-text {% if producto[8] %}vencimiento-proximo{% endif %}">{{ producto[7] }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="detail-row">
                                        <span class="detail-label">Precio:</span>
                                        <div class="precio-line">
                                            <div class="precio-container {% if precio == precio_minimo and precios_producto|length > 1 %}precio-mejor{% endif %}">
                                                <span>S/</span>
                                                <span class="price-value">{{ "%.2f"|format(precio) }}</span>
                                            </div>
                                            {% if 'pionero' in fuente_lower and producto[6] %}
                                            <div class="precio-escala-badge">Escala: +{{ (producto[5]|float)|int }} | Precio escala: S/ {{ "%.2f"|format(producto[6]|float) }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="cart-controls">
                                    <div class="quantity-controls">
                                        <button type="button" class="qty-btn" onclick="changeQuantity(this, -1)">-</button>
                                        <input type="number" class="qty-input" value="1" min="1" onchange="updateSubtotal(this)">
                                        <button type="button" class="qty-btn" onclick="changeQuantity(this, 1)">+</button>
                                    </div>
                                    <button type="button" class="add-to-cart-btn" data-nombre="{{ producto[0] }}" data-proveedor="{{ producto[2] }}" data-precio-base="{{ precio }}" data-escala="{{ producto[5] or '' }}" data-precio-escala="{{ producto[6] or '' }}" data-fuente="{{ fuente }}" onclick="addToCartFromButton(this)">üõí Agregar al Carrito</button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

            <!-- Vista de Lista -->
            <div id="list-view" class="list-view">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>C√≥digo</th>
                                <th>Proveedor</th>
                                <th>F. Venc.</th>
                                <th>Precio</th>
                                <th>Fuente</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in resultados %}
                            <tr data-precio-base="{{ r[3]|float }}" data-escala="{{ r[5] or '' }}" data-precio-escala="{{ r[6] or '' }}">
                                <td><strong>{{ r[0] }}</strong></td>
                                <td><span class="codigo-badge">{{ r[1] }}</span></td>
                                <td class="proveedor-text">{{ r[2] }}</td>
                                <td>
                                    {% set fuente_lower = r[4].split('|')[0].lower() %}
                                    {% if 'prosalud' in fuente_lower and r[7] %}
                                        <span class="vencimiento-text {% if r[8] %}vencimiento-proximo{% endif %}">{{ r[7] }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="precio-line">
                                        <div class="precio-container">
                                            <span>S/</span>
                                            <span class="price-value">{{ "%.2f"|format(r[3]|float) }}</span>
                                        </div>
                                        {% if 'pionero' in fuente_lower and r[6] %}
                                            <div class="precio-escala-badge">Escala: +{{ (r[5]|float)|int }} | Precio escala: S/ {{ "%.2f"|format(r[6]|float) }}</div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if 'pionero' in fuente_lower %}
                                        <span class="fuente-badge fuente-pionero">üì¶ {{ r[4].split('|')[0] }}</span>
                                    {% elif 'prosalud' in fuente_lower %}
                                        <span class="fuente-badge fuente-prosalud">üè• {{ r[4].split('|')[0] }}</span>
                                    {% elif 'farmacom' in fuente_lower %}
                                        <span class="fuente-badge fuente-farmacom">üíä {{ r[4].split('|')[0] }}</span>
                                    {% elif 'web' in fuente_lower %}
                                        <span class="fuente-badge fuente-web">üåê {{ r[4].split('|')[0] }}</span>
                                    {% else %}
                                        <span class="fuente-badge fuente-otro">üìã {{ r[4].split('|')[0] }}</span>
                                    {% endif %}
                                </td>
                                <td class="cart-controls-cell">
                                    <div class="quantity-controls">
                                        <button type="button" class="qty-btn" onclick="changeQuantity(this, -1)">-</button>
                                        <input type="number" class="qty-input" value="1" min="1" onchange="updateSubtotal(this)">
                                        <button type="button" class="qty-btn" onclick="changeQuantity(this, 1)">+</button>
                                    </div>
                                    <button type="button" class="add-to-cart-btn" data-nombre="{{ r[0] }}" data-proveedor="{{ r[2] }}" data-precio-base="{{ r[3]|float }}" data-escala="{{ r[5] or '' }}" data-precio-escala="{{ r[6] or '' }}" data-fuente="{{ r[4].split('|')[0] }}" onclick="addToCartFromButton(this)">üõí Agregar</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% if total_pages > 1 %}
        <div class="pagination">
            <form method="POST" class="pagination-form">
                <input type="hidden" name="q" value="{{ current_q }}">
                <input type="hidden" name="proveedor" value="{{ current_proveedor }}">
                <input type="hidden" name="sort" value="{{ current_sort }}">
                <button type="submit" name="page" value="{{ page - 1 }}" {% if page <= 1 %}disabled{% endif %}>Anterior</button>
                <span>Pagina {{ page }} de {{ total_pages }} ({{ total_count }} resultados)</span>
                <button type="submit" name="page" value="{{ page + 1 }}" {% if page >= total_pages %}disabled{% endif %}>Siguiente</button>
            </form>
        </div>
        {% endif %}
        {% endif %}

        <!-- Panel del Carrito -->
        <div id="cart-panel" class="cart-panel">
            <div class="cart-header">
                <h3>üõí Carrito de Compras</h3>
                <button class="cart-toggle" onclick="toggleCart()">‚úï</button>
            </div>
            <div id="cart-items" class="cart-items">
                <!-- Items del carrito se agregar√°n aqu√≠ -->
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <strong>Total: S/ <span id="cart-total">0.00</span></strong>
                </div>
                <button class="export-btn" onclick="exportToExcel()">üìä Exportar a Excel</button>
            </div>
        </div>

    </div>
</body>
</html>